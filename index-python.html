<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Arbitrage Bot v3.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0a0e17;
            --bg-card: rgba(18, 25, 42, 0.92);
            --text: #e8ecf4;
            --hint: #8b9dc3;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
            --yellow: #f59e0b;
            --purple: #a855f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(160deg, #0a0e17 0%, #0f172a 35%, #1e1b4b 70%, #0f172a 100%);
            color: var(--text);
            padding: 12px;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse 100% 80% at 50% -30%, rgba(59,130,246,0.3), transparent 50%),
                radial-gradient(ellipse 80% 60% at 90% 20%, rgba(139,92,246,0.2), transparent 45%);
            pointer-events: none; z-index: 0;
        }
        .container { max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }

        /* Header */
        .header { text-align: center; margin-bottom: 12px; }
        .header h1 { font-size: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .header .subtitle { font-size: 12px; color: var(--hint); margin-top: 4px; }

        /* Status */
        .status-bar {
            text-align: center; padding: 8px 12px; margin-bottom: 10px;
            border-radius: 10px; font-size: 13px; font-weight: 500;
        }
        .status-bar.connected { background: var(--green); color: white; }
        .status-bar.disconnected { background: var(--red); color: white; }
        .status-bar.loading { background: var(--yellow); color: #000; }

        /* Settings panel */
        .settings {
            background: var(--bg-card); border-radius: 12px; padding: 14px;
            margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.06);
        }
        .settings-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--hint); }
        .settings-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .settings-row:last-child { margin-bottom: 0; }
        .settings-row label { font-size: 12px; color: var(--hint); white-space: nowrap; min-width: 110px; }
        .settings-row input {
            flex: 1; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 8px 10px; color: var(--text); font-size: 13px;
            outline: none;
        }
        .settings-row input:focus { border-color: var(--blue); }

        /* Buttons */
        .btn-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .btn {
            flex: 1; padding: 10px; border: none; border-radius: 10px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { background: var(--blue); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid rgba(255,255,255,0.1); }

        /* Summary */
        .summary {
            text-align: center; padding: 8px; margin-bottom: 12px;
            font-size: 13px; color: var(--hint); display: flex;
            align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap;
        }
        .summary .tag {
            display: inline-block; padding: 3px 8px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
        }
        .tag-green { background: rgba(34,197,94,0.15); color: var(--green); }
        .tag-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
        .tag-yellow { background: rgba(245,158,11,0.15); color: var(--yellow); }

        /* Cards */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card {
            background: linear-gradient(145deg, rgba(18,25,42,0.95), rgba(30,27,75,0.6));
            border-radius: 14px; padding: 14px 16px; position: relative;
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card.profitable { border-color: rgba(34,197,94,0.3); }
        .card.unprofitable { border-color: rgba(239,68,68,0.2); }

        /* Card header */
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-head-left { display: flex; align-items: center; gap: 10px; }
        .coin-icon {
            width: 40px; height: 40px; border-radius: 50%; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .coin-icon img { width: 100%; height: 100%; object-fit: cover; }
        .coin-name { font-size: 16px; font-weight: 700; }

        /* Spread badge */
        .spread-badge {
            font-size: 14px; font-weight: 700; padding: 5px 10px;
            border-radius: 8px; color: white;
        }
        .spread-badge.positive { background: var(--green); }
        .spread-badge.negative { background: var(--red); }

        /* Best spread section */
        .best-spread {
            padding: 10px 12px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 14px; font-weight: 600;
        }
        .best-spread.positive {
            background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
            color: var(--green); border-left: 3px solid var(--green);
        }
        .best-spread.negative {
            background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(239,68,68,0.04));
            color: var(--red); border-left: 3px solid var(--red);
        }

        /* Market opportunity */
        .opportunity {
            background: rgba(255,255,255,0.03); border-radius: 10px;
            padding: 12px; margin-bottom: 10px;
        }
        .opp-title { font-size: 12px; font-weight: 600; color: var(--hint); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .opp-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 13px; }
        .opp-label { color: var(--hint); }
        .opp-value { font-weight: 600; }
        .opp-value.green { color: var(--green); }
        .opp-value.red { color: var(--red); }
        .opp-value.blue { color: var(--blue); }
        .opp-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 6px 0; }

        /* Exchange prices grid */
        .ex-grid { display: flex; flex-direction: column; gap: 4px; font-size: 12px; }
        .ex-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 8px; border-radius: 6px;
        }
        .ex-row.buy-row {
            background: linear-gradient(90deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05));
            border-left: 3px solid var(--green);
        }
        .ex-row.sell-row {
            background: linear-gradient(90deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05));
            border-left: 3px solid var(--blue);
        }
        .ex-row.buy-row .ex-name, .ex-row.buy-row .ex-prices { color: #4ade80; font-weight: 600; }
        .ex-row.sell-row .ex-name, .ex-row.sell-row .ex-prices { color: #60a5fa; font-weight: 600; }
        .ex-name { color: var(--hint); }
        .ex-prices { font-weight: 500; }
        .ex-tag { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; margin-left: 4px; }

        /* Profit amounts */
        .profit-grid { display: flex; flex-direction: column; gap: 4px; }
        .profit-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 8px; background: rgba(255,255,255,0.04); border-radius: 6px;
            font-size: 12px;
        }
        .profit-amount { font-weight: 500; }
        .profit-result { font-weight: 600; }
        .profit-result.green { color: var(--green); }
        .profit-result.red { color: var(--red); }
        .optimal-star { color: var(--yellow); margin-left: 4px; font-size: 10px; }

        .loading-text {
            text-align: center; padding: 40px 20px; color: var(--hint); font-size: 14px; line-height: 1.6;
        }

        /* Toggle card details */
        .card-toggle { cursor: pointer; }
        .card-details { display: none; }
        .card-details.open { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Arbitrage Bot</h1>
            <div class="subtitle">–ü–æ–∏—Å–∫ —Ü–µ–Ω–æ–≤—ã—Ö —Å–ø—Ä–µ–¥–æ–≤ –º–µ–∂–¥—É –±–∏—Ä–∂–∞–º–∏ ¬∑ Powered by CCXT</div>
        </div>
        <div id="statusBar" class="status-bar loading">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div class="settings" id="settingsPanel">
            <div class="settings-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="settings-row">
                <label>–ú–∏–Ω. —Å–ø—Ä–µ–¥ %</label>
                <input type="number" id="minSpread" value="0" step="0.1" min="0">
            </div>
            <div class="settings-row">
                <label>–ú–∏–Ω. –ø—Ä–∏–±—ã–ª—å $</label>
                <input type="number" id="minProfit" value="0" step="0.01" min="0">
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" id="refreshBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-secondary" id="toggleSettings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div id="content">
            <div class="loading-text">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <script>
        'use strict';

        const urlParams = new URLSearchParams(window.location.search);
        const API_URL = urlParams.get('python_url') || 'https://cryptobot-python-service-production.up.railway.app';
        const UPDATE_INTERVAL = 4000;

        const contentDiv = document.getElementById('content');
        const statusBar = document.getElementById('statusBar');
        const refreshBtn = document.getElementById('refreshBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const toggleSettingsBtn = document.getElementById('toggleSettings');
        const minSpreadInput = document.getElementById('minSpread');
        const minProfitInput = document.getElementById('minProfit');

        let updateTimer = null;
        let settingsVisible = true;

        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        // Coin icons
        const COIN_ICON_CDN = 'https://cdn.jsdelivr.net/npm/cryptocurrency-icons@0.18.1/128/color';
        const COIN_ICON_ALIAS = { '1000pepe': 'pepe', '1000pep': 'pepe', 'pol': 'matic', 'w': 'wbtc' };
        const LOCAL_ICONS = ['btc','eth','bnb','xrp','sol','trx','doge','ada','bch','xmr','link','xlm','ltc','dot','uni','avax','atom','etc','fil','matic','icp','snx','comp','crv','bat','zec','mkr','enj','yfi','eos','neo'];
        const COIN_COLORS = {
            btc:'#f7931a',eth:'#627eea',bnb:'#f3ba2f',xrp:'#23292f',sol:'#14f195',trx:'#ef0027',
            doge:'#c3a634',ada:'#0033ad',bch:'#8dc351',xmr:'#ff6600',link:'#2a5ada',xlm:'#14b6e7',
            sui:'#6fbcf0',ltc:'#345d9d',avax:'#e84142',dot:'#e6007a',uni:'#ff007a',atom:'#2e3148',
            etc:'#328332',fil:'#0090ff',matic:'#8247e5',icp:'#29abe2',snx:'#00d1ff',comp:'#00d395',
        };

        function coinIcon(coin) {
            const key = (coin || '').replace(/USDT$/i,'').toLowerCase();
            const sym = COIN_ICON_ALIAS[key] || key;
            if (LOCAL_ICONS.includes(sym)) return 'icons/' + sym + '.png';
            return COIN_ICON_CDN + '/' + sym + '.png';
        }
        function coinFallback(coin) {
            const key = (coin || '').replace(/USDT$/i,'').toLowerCase();
            const letter = (key.charAt(0) || '?').toUpperCase();
            const color = COIN_COLORS[key] || '#8b5cf6';
            return `data:image/svg+xml;base64,${btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128"><rect width="128" height="128" rx="64" fill="${color}"/><text x="64" y="90" font-family="Arial,sans-serif" font-size="72" font-weight="700" fill="white" text-anchor="middle">${letter}</text></svg>`)}`;
        }

        function fmt(n, d = 2) { return Number.isFinite(n) ? n.toFixed(d) : 'N/A'; }
        function fmtPrice(n) {
            if (!Number.isFinite(n)) return 'N/A';
            if (n >= 1000) return n.toFixed(2);
            if (n >= 1) return n.toFixed(4);
            if (n >= 0.01) return n.toFixed(6);
            return n.toFixed(8);
        }

        // Toggle settings
        toggleSettingsBtn.onclick = () => {
            settingsVisible = !settingsVisible;
            settingsPanel.style.display = settingsVisible ? 'block' : 'none';
        };

        // Fetch arbitrage data
        async function fetchArbitrage() {
            try {
                const minSpread = parseFloat(minSpreadInput.value) || 0;
                const minProfit = parseFloat(minProfitInput.value) || 0;
                const url = `${API_URL}/api/arbitrage?min_spread=${minSpread}&min_profit=${minProfit}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();

                if (result.success) {
                    const opps = result.opportunities || [];
                    statusBar.className = 'status-bar connected';
                    statusBar.textContent = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ | ${result.totalExchanges} –±–∏—Ä–∂ | ${result.totalCoins} –º–æ–Ω–µ—Ç`;
                    renderOpportunities(opps, result);
                } else {
                    throw new Error(result.error || 'No data');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                statusBar.className = 'status-bar disconnected';
                statusBar.textContent = '‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å—É';
                contentDiv.innerHTML = `<div class="loading-text">‚ùå –û—à–∏–±–∫–∞: ${error.message}<br><br><code>${API_URL}</code></div>`;
            }
        }

        function renderOpportunities(opps, meta) {
            if (opps.length === 0) {
                contentDiv.innerHTML = `
                    <div class="loading-text">
                        üìä –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏<br><br>
                        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –º–∏–Ω. —Å–ø—Ä–µ–¥ –∏–ª–∏ –º–∏–Ω. –ø—Ä–∏–±—ã–ª—å
                    </div>`;
                return;
            }

            const profitable = opps.filter(o => o.profitUsdt >= 0);
            const bestSpread = opps[0];

            let html = `
                <div class="summary">
                    <span class="tag tag-blue">${opps.length} –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π</span>
                    <span class="tag tag-green">${profitable.length} –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö</span>
                    <span class="tag tag-yellow">–õ—É—á—à–∏–π —Å–ø—Ä–µ–¥: ${fmt(bestSpread.spreadPercent, 2)}%</span>
                </div>
                <div class="card-list">`;

            for (let i = 0; i < opps.length; i++) {
                const o = opps[i];
                const isProfit = o.profitUsdt >= 0;
                const symbol = o.symbol.replace('USDT', '/USDT');
                const icon = coinIcon(o.symbol);
                const fallback = coinFallback(o.symbol);
                const cardId = `card-${i}`;

                // –†–∞—Å—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å—É–º–º—ã
                const amounts = [100, 250, 500, 1000, 2500, 5000];
                const profitRows = amounts.map(amt => {
                    const afterBuy = amt * (1 - o.buyFee);
                    const crypto = afterBuy / o.buyPrice;
                    const gross = crypto * o.sellPrice;
                    const net = gross * (1 - o.sellFee);
                    const p = net - amt;
                    return { amount: amt, profit: p };
                });

                // Best amount
                const bestAmt = profitRows.reduce((best, r) => r.profit > best.profit ? r : best, profitRows[0]);

                let exHtml = '';
                for (const ex of o.exchanges) {
                    if (!ex.hasData) {
                        exHtml += `<div class="ex-row" style="opacity:0.4;"><span class="ex-name">${ex.name}</span><span class="ex-prices" style="font-style:italic;">‚Äî</span></div>`;
                        continue;
                    }
                    const isBuy = ex.id === o.buyExchange;
                    const isSell = ex.id === o.sellExchange;
                    const cls = isBuy ? 'ex-row buy-row' : (isSell ? 'ex-row sell-row' : 'ex-row');
                    const tag = isBuy ? '<span class="ex-tag">–ü–û–ö–£–ü–ö–ê</span>' : (isSell ? '<span class="ex-tag">–ü–†–û–î–ê–ñ–ê</span>' : '');
                    exHtml += `<div class="${cls}"><span class="ex-name">${ex.name} ${tag}</span><span class="ex-prices">Ask ${fmtPrice(ex.ask)} / Bid ${fmtPrice(ex.bid)}</span></div>`;
                }

                let profitGridHtml = '';
                for (const r of profitRows) {
                    const isBest = r.amount === bestAmt.amount && bestAmt.profit > 0;
                    const cls = r.profit >= 0 ? 'green' : 'red';
                    const sign = r.profit >= 0 ? '+' : '';
                    profitGridHtml += `
                        <div class="profit-row">
                            <span class="profit-amount">${r.amount} USDT${isBest ? '<span class="optimal-star">‚≠ê</span>' : ''}</span>
                            <span class="profit-result ${cls}">${sign}${fmt(r.profit, 4)} USDT</span>
                        </div>`;
                }

                html += `
                <div class="card ${isProfit ? 'profitable' : 'unprofitable'}">
                    <div class="card-head card-toggle" onclick="toggleCard('${cardId}')">
                        <div class="card-head-left">
                            <div class="coin-icon">
                                <img src="${icon}" alt="${o.symbol}" onerror="this.src='${fallback}'">
                            </div>
                            <span class="coin-name">${symbol}</span>
                        </div>
                        <span class="spread-badge ${isProfit ? 'positive' : 'negative'}">${fmt(o.spreadPercent, 2)}%</span>
                    </div>

                    <div class="best-spread ${isProfit ? 'positive' : 'negative'}">
                        üõí <strong>${o.buyExchangeName}</strong> ‚Üí üí∏ <strong>${o.sellExchangeName}</strong>
                        &nbsp;|&nbsp; ${isProfit ? '+' : ''}${fmt(o.profitUsdt, 4)} USDT
                    </div>

                    <div class="card-details ${i < 3 ? 'open' : ''}" id="${cardId}">
                        <div class="opportunity">
                            <div class="opp-title">üìã Market Opportunity (${o.amount} USDT)</div>
                            <div class="opp-row"><span class="opp-label">üõí –ö—É–ø–∏—Ç—å –Ω–∞ ${o.buyExchangeName}:</span><span class="opp-value">${fmtPrice(o.buyPrice)}</span></div>
                            <div class="opp-row"><span class="opp-label">üí∏ –ü—Ä–æ–¥–∞—Ç—å –Ω–∞ ${o.sellExchangeName}:</span><span class="opp-value">${fmtPrice(o.sellPrice)}</span></div>
                            <div class="opp-divider"></div>
                            <div class="opp-row"><span class="opp-label">üìä –°–ø—Ä–µ–¥:</span><span class="opp-value ${isProfit ? 'green' : 'red'}">${fmt(o.spreadPercent, 4)}%</span></div>
                            <div class="opp-divider"></div>
                            <div class="opp-title" style="margin-top:8px;">üí≥ –ö–æ–º–∏—Å—Å–∏–∏</div>
                            <div class="opp-row"><span class="opp-label">${o.buyExchangeName} (${(o.buyFee*100).toFixed(2)}%)</span><span class="opp-value red">-${fmt(o.buyFeeUsdt, 4)} USDT</span></div>
                            <div class="opp-row"><span class="opp-label">${o.sellExchangeName} (${(o.sellFee*100).toFixed(2)}%)</span><span class="opp-value red">-${fmt(o.sellFeeUsdt, 4)} USDT</span></div>
                            <div class="opp-divider"></div>
                            <div class="opp-row"><span class="opp-label">üí∞ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</span><span class="opp-value ${isProfit ? 'green' : 'red'}" style="font-size:14px;font-weight:700;">${isProfit ? '+' : ''}${fmt(o.profitUsdt, 4)} USDT</span></div>
                        </div>

                        <div class="opportunity">
                            <div class="opp-title">üìä –¶–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–∞—Ö</div>
                            <div class="ex-grid">${exHtml}</div>
                        </div>

                        <div class="opportunity">
                            <div class="opp-title">üí∞ –ü—Ä–∏–±—ã–ª—å –ø–æ —Å—É–º–º–∞–º –≤—Ö–æ–¥–∞</div>
                            <div class="profit-grid">${profitGridHtml}</div>
                            ${bestAmt.profit > 0 ? `<div style="margin-top:8px;padding:8px;background:rgba(34,197,94,0.1);border-radius:8px;font-size:12px;color:var(--green);font-weight:600;">‚≠ê –õ—É—á—à–∏–π –≤—Ö–æ–¥: ${bestAmt.amount} USDT ‚Üí –ø—Ä–∏–±—ã–ª—å +${fmt(bestAmt.profit, 4)} USDT</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }

            html += '</div>';
            contentDiv.innerHTML = html;
        }

        function toggleCard(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        }

        refreshBtn.onclick = () => fetchArbitrage();

        function startAutoUpdate() {
            if (updateTimer) clearInterval(updateTimer);
            updateTimer = setInterval(fetchArbitrage, UPDATE_INTERVAL);
        }

        // –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—Å –¥–µ–±–∞—É–Ω—Å–æ–º)
        let settingsTimeout = null;
        function onSettingsChange() {
            clearTimeout(settingsTimeout);
            settingsTimeout = setTimeout(() => fetchArbitrage(), 500);
        }
        minSpreadInput.addEventListener('input', onSettingsChange);
        minProfitInput.addEventListener('input', onSettingsChange);

        console.log('ü§ñ Arbitrage Bot v3.0 started');
        fetchArbitrage();
        startAutoUpdate();
    </script>
</body>
</html>
